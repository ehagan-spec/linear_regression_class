---
title: "Reproducible Analysis Template"
author: "Linear Regression Course"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    code_folding: show
    theme: flatly
    highlight: tango
    df_print: paged
---

## Overview

This vignette serves as a **template for reproducible statistical analysis** using R and the tidyverse framework. You can use this as a starting point for your own analyses, adapting it to your specific research questions and data.

### Learning Objectives

By the end of this vignette, you will be able to:
- Structure a complete reproducible analysis
- Follow best practices for data analysis workflow
- Document your analysis clearly for others (and future you)
- Use tidyverse tools effectively
- Create publication-quality outputs

### Prerequisites

- Basic familiarity with R and RStudio
- Understanding of R Markdown
- Basic knowledge of the tidyverse packages

## Setup

```{r setup, message=FALSE, warning=FALSE}
# Load required packages
library(tidyverse)    # Data manipulation and visualization
library(broom)        # Tidy model outputs
library(car)          # Regression diagnostics
library(lmtest)       # Testing linear regression models
library(knitr)        # Knitr options
library(skimr)        # Detailed data summaries

# Set default ggplot theme for consistent visualizations
theme_set(theme_minimal(base_size = 12))

# Set knitr options
opts_chunk$set(
  echo = TRUE,           # Show code
  message = FALSE,       # Hide messages
  warning = FALSE,       # Hide warnings
  fig.width = 8,        # Default figure width
  fig.height = 5,       # Default figure height
  fig.align = "center"  # Center figures
)

# Set seed for reproducibility
set.seed(42)
```

## 1. Research Question

**Clearly state your research question at the beginning.**

Example: *What is the relationship between hours of exercise per week and resting heart rate? Does this relationship differ between age groups?*

### Hypotheses

- **Null hypothesis (H₀)**: There is no relationship between exercise hours and resting heart rate
- **Alternative hypothesis (H₁)**: Exercise hours are negatively associated with resting heart rate

## 2. Data Import

### Load the Data

```{r import-data}
# For this template, we'll generate simulated data
# In your analysis, replace this with:
# data <- read_csv("path/to/your/data.csv")

# Simulated data: Exercise and heart rate
health_data <- tibble(
  id = 1:200,
  age = sample(18:65, 200, replace = TRUE),
  age_group = cut(age, breaks = c(0, 30, 50, 100), 
                  labels = c("Young", "Middle", "Senior")),
  sex = sample(c("Male", "Female"), 200, replace = TRUE),
  exercise_hours = pmax(0, rnorm(200, mean = 5, sd = 3)),
  resting_hr = 80 - 2 * exercise_hours + 0.3 * age + rnorm(200, sd = 5),
  weight_kg = rnorm(200, mean = 70, sd = 15)
)

# Display first few rows
head(health_data)
```

### Data Documentation

**Always document your data:**

- **Source**: [Describe where data came from]
- **Collection date**: [When was it collected]
- **Sample size**: `r nrow(health_data)` observations
- **Number of variables**: `r ncol(health_data)`

## 3. Data Exploration

### Initial Inspection

```{r inspect-data}
# Data structure
glimpse(health_data)

# Comprehensive summary using skimr
skim(health_data)
```

### Summary Statistics

```{r summary-stats}
# Summary statistics for key variables
health_data %>%
  select(age, exercise_hours, resting_hr, weight_kg) %>%
  summary()

# Group-wise summaries
health_data %>%
  group_by(age_group) %>%
  summarize(
    n = n(),
    mean_exercise = mean(exercise_hours),
    mean_hr = mean(resting_hr),
    sd_hr = sd(resting_hr)
  ) %>%
  kable(digits = 2, caption = "Summary Statistics by Age Group")
```

### Data Visualization

```{r eda-plots, fig.height=6}
# Distribution of key variables
p1 <- ggplot(health_data, aes(x = exercise_hours)) +
  geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7) +
  labs(title = "Distribution of Exercise Hours", 
       x = "Exercise Hours per Week", y = "Count")

p2 <- ggplot(health_data, aes(x = resting_hr)) +
  geom_histogram(bins = 30, fill = "coral", alpha = 0.7) +
  labs(title = "Distribution of Resting Heart Rate",
       x = "Resting Heart Rate (bpm)", y = "Count")

# Display plots
p1
p2
```

### Relationship Visualization

```{r scatter-plot}
# Main relationship of interest
ggplot(health_data, aes(x = exercise_hours, y = resting_hr)) +
  geom_point(alpha = 0.5, size = 2) +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  labs(
    title = "Exercise and Resting Heart Rate",
    x = "Exercise Hours per Week",
    y = "Resting Heart Rate (bpm)",
    caption = "Blue line: linear regression with 95% confidence interval"
  )
```

```{r by-group-plot}
# By age group
ggplot(health_data, aes(x = exercise_hours, y = resting_hr, color = age_group)) +
  geom_point(alpha = 0.5, size = 2) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Exercise and Heart Rate by Age Group",
    x = "Exercise Hours per Week",
    y = "Resting Heart Rate (bpm)",
    color = "Age Group"
  ) +
  theme(legend.position = "bottom")
```

### Check for Missing Data

```{r missing-data}
# Count missing values
health_data %>%
  summarize(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Missing") %>%
  filter(Missing > 0) %>%
  kable(caption = "Missing Values by Variable")

# Note: Our simulated data has no missing values
```

## 4. Statistical Analysis

### Simple Linear Regression

```{r simple-model}
# Fit the model
model_simple <- lm(resting_hr ~ exercise_hours, data = health_data)

# Tidy output
tidy(model_simple, conf.int = TRUE) %>%
  kable(digits = 3, caption = "Simple Linear Regression Results")

# Model statistics
glance(model_simple) %>%
  select(r.squared, adj.r.squared, sigma, statistic, p.value) %>%
  kable(digits = 3, caption = "Model Fit Statistics")
```

**Interpretation**: 
For each additional hour of exercise per week, resting heart rate decreases by `r round(coef(model_simple)[2], 2)` bpm (p < 0.001).

### Multiple Regression

```{r multiple-model}
# Include additional predictors
model_multiple <- lm(resting_hr ~ exercise_hours + age + sex, data = health_data)

# Tidy output
tidy(model_multiple, conf.int = TRUE) %>%
  kable(digits = 3, caption = "Multiple Regression Results")

# Model comparison
glance(model_multiple) %>%
  select(r.squared, adj.r.squared, AIC, BIC) %>%
  kable(digits = 3, caption = "Multiple Regression Fit Statistics")
```

## 5. Model Diagnostics

### Residual Plots

```{r diagnostic-plots, fig.height=8}
# Get augmented data with residuals
model_data <- augment(model_multiple)

# Create diagnostic plots
p1 <- ggplot(model_data, aes(x = .fitted, y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(se = FALSE) +
  labs(title = "Residuals vs Fitted", x = "Fitted Values", y = "Residuals")

p2 <- ggplot(model_data, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Normal Q-Q Plot", x = "Theoretical Quantiles", y = "Sample Quantiles")

p3 <- ggplot(model_data, aes(x = .fitted, y = sqrt(abs(.std.resid)))) +
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  labs(title = "Scale-Location", x = "Fitted Values", y = "√|Standardized Residuals|")

p4 <- ggplot(model_data, aes(x = .hat, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  labs(title = "Residuals vs Leverage", x = "Leverage", y = "Standardized Residuals")

# Display all plots
p1
p2
p3
p4
```

### Assumption Checks

```{r assumptions}
# Formal tests (use with caution)
# Normality of residuals
shapiro_test <- shapiro.test(residuals(model_multiple))
cat("Shapiro-Wilk test p-value:", round(shapiro_test$p.value, 4), "\n")

# Homoscedasticity
bp_test <- bptest(model_multiple)
cat("Breusch-Pagan test p-value:", round(bp_test$p.value, 4), "\n")

# Multicollinearity
cat("\nVariance Inflation Factors:\n")
vif(model_multiple)
```

## 6. Results Summary

### Key Findings

1. **Exercise effect**: Each additional hour of weekly exercise is associated with a decrease of `r round(coef(model_multiple)["exercise_hours"], 2)` bpm in resting heart rate (95% CI: [`r round(confint(model_multiple)["exercise_hours",], 2)`]), adjusting for age and sex.

2. **Age effect**: Resting heart rate increases by `r round(coef(model_multiple)["age"], 2)` bpm per year of age.

3. **Model fit**: The model explains `r round(100*summary(model_multiple)$r.squared, 1)`% of the variance in resting heart rate.

### Visualization of Results

```{r results-plot}
# Create prediction plot
new_data <- expand_grid(
  exercise_hours = seq(0, 12, by = 0.5),
  age = mean(health_data$age),
  sex = "Male"
)

predictions <- augment(model_multiple, newdata = new_data)

ggplot() +
  geom_point(data = health_data, aes(x = exercise_hours, y = resting_hr),
             alpha = 0.3) +
  geom_line(data = predictions, aes(x = exercise_hours, y = .fitted),
            color = "blue", linewidth = 1) +
  geom_ribbon(data = predictions, 
              aes(x = exercise_hours, ymin = .fitted - 1.96 * .se.fit,
                  ymax = .fitted + 1.96 * .se.fit),
              alpha = 0.2, fill = "blue") +
  labs(
    title = "Predicted Effect of Exercise on Resting Heart Rate",
    x = "Exercise Hours per Week",
    y = "Resting Heart Rate (bpm)",
    caption = "Adjusted for age and sex; ribbon shows 95% confidence interval"
  )
```

## 7. Discussion

### Interpretation

Our analysis provides evidence for a negative association between exercise and resting heart rate. This finding is consistent with physiological expectations, as regular exercise improves cardiovascular efficiency.

### Limitations

- This is simulated data for demonstration purposes
- In a real analysis, consider: sample representativeness, measurement error, confounding variables, causal inference limitations

### Future Directions

- Include additional covariates (BMI, smoking status, etc.)
- Test for interactions (e.g., does the exercise effect differ by age?)
- Consider non-linear relationships
- Validate findings in an independent dataset

## 8. Conclusion

This template demonstrates a complete reproducible analysis workflow. Key elements include:

- ✅ Clear research question
- ✅ Well-documented data import and exploration
- ✅ Appropriate visualizations
- ✅ Statistical modeling with diagnostics
- ✅ Clear interpretation of results
- ✅ Transparency about limitations

## Appendix: Complete Analysis Code

```{r complete-code, eval=FALSE}
# This section contains all analysis code without interruption
# Useful for copying the entire workflow

library(tidyverse)
library(broom)
library(car)

# Import data
data <- read_csv("path/to/data.csv")

# Explore
glimpse(data)
summary(data)

# Visualize
ggplot(data, aes(x = predictor, y = outcome)) +
  geom_point() +
  geom_smooth(method = "lm")

# Model
model <- lm(outcome ~ predictor + covariate, data = data)
summary(model)

# Diagnostics
plot(model)
vif(model)

# Results
tidy(model, conf.int = TRUE)
```

## Session Information

```{r session-info}
sessionInfo()
```

---

**Template created**: `r Sys.Date()`

**Repository**: [github.com/crweber9874/linear_regression_class](https://github.com/crweber9874/linear_regression_class)

**License**: CC BY-SA 4.0
